<!DOCTYPE html> 
<html>
<head>
    <title>Fönstertittaren</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/jquery.mobile-1.3.2.min.css" />
    <script src="js/jquery-1.10.1.min.js"></script>
    <script src="js/jquery.mobile-1.3.2.min.js"></script>
    <!--<script src="http://debug.phonegap.com/target/target-script-min.js#brankelibroffoiu"></script>-->
</head>

<body>

<div data-role="page" id="formpage">
    <div data-role="header">
        <h1>Fönstertittaren</h1>
    </div><!-- /header -->

    {% block surveys %}

    {% endblock %}

    <div data-role="footer" data-id="foo1" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#formpage">Form page</a></li>
                <li><a href="#submissions-page">Submitted Entries</a></li>
                <li><a href="/submissions">Submission on server</a></li>
            </ul>
        </div><!-- /navbar -->
    </div><!-- /footer -->
</div>

<div data-role="page" id="submissions-page">
    <div data-role="header">
        <h1>Fönstertittaren</h1>
    </div><!-- /header -->
    <div data-role="content"><br>
        <div id="connection"></div><br><br>
        <div id="localvalues"></div>

    </div>

    <div data-role="footer" data-id="foo1" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#formpage">Form page</a></li>
                <li><a href="#submissions-page">Submitted Entries</a></li>
                <li><a href="/submissions">Submission on server</a></li>
            </ul>
        </div><!-- /navbar -->
    </div><!-- /footer -->
</div>

<script src="js/exif.js"></script> <!-- library to find orientation for uploaded images -->
<script type="text/javascript" src="js/binaryajax.js"></script> <!-- helper library for exif.js -->
<script src="js/megapix-image.js"></script> <!-- library which resizes images and unsqaush them on iOS -->
<script src="js/megapix-image.test.js"></script> <!-- includes the functions which get the image dom and calls the image resize -->

<script>

$("#fileinput").change(function(){console.log("change");});


</script>
<script>
$(document).ready(function(){
    reloadSubmissions();

    //submit entry, store it in HTML5 localStorage
    $("#form").submit(function(){
      console.log("click upload");    
      var formValues = $(this).serialize();
      var tm = new Date().getTime();
      localStorage.setItem(tm, formValues);
      console.log("Form submitted");
      reloadSubmissions();
      return false;
      
    });

    function reloadSubmissions() {
    $("#localvalues").empty();
        var i = 0, //i is standing for int
        oJson = {}, //o is standing for object
        sKey; //s is standing for string
        while ((sKey = window.localStorage.key(i))) {
          oJson[sKey] = window.localStorage.getItem(sKey);
          i++;
        }
        //console.log(oJson);

        for (var item in oJson) {
          if (!isNaN(item)) {
            //console.log(item + oJson[item]);
           $("#localvalues").append(
            "<div class=\"submission\" id=\"" + item +"\">Submission: " + item + 
            " <button class=\"submitentry\" data-inline=\"true\" id=\"" + item  + "\">Submit Entry</button><a href='#'id='" + item +"'>Delete</a></div>"
            );
          }
        }
    }

    //submit localstorage entry to server
    $(document).on("click", ".submitentry", function(){
        console.log($(this).attr("id"));
        console.log(window.localStorage.getItem($(this).attr("id")));
        var formData = window.localStorage.getItem($(this).attr("id"));
        $.post('/pic', formData).done(receivedData).fail(errorUploading);
    });

    function receivedData(data){
        alert(data);
    }

    function errorUploading(data){
        alert(data);
    }

    //delete submitted entry 
    $(document).on("click", "#localvalues .submission > a", function(){
        localStorage.removeItem($(this).attr("id"));
        alert("you deleted submission " + $(this).attr("id"));
        reloadSubmissions();
    });


    

    //check and display network connection on submitted entries page. If offline, disable submit button.
    setInterval(function () {
      if (navigator.onLine) {
        $("#connection").html("You are now online!");
       // $(".submitentry").removeAttr("disabled");
      } else {
        $("#connection").html("You are now offline and will not be able to submit entries.");
        $(".submitentry").addClass('ui-disabled');
      }
    }, 250);


});
</script>


</body>
</html>